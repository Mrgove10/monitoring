<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Monitoring</title>
    <script src="https://unpkg.com/mqtt@4.0.0/dist/mqtt.min.js"></script>
</head>

<body>
    <h1>Monitoring</h1>
    Machines currently sending data :
    <li id="area"></li>

    <script>
        var client = mqtt.connect('mqtt://test.mosquitto.org:8080')

        client.on('connect', function () {
            client.subscribe('2399ce45-7651-45a6-acaf-f8c5ca71180a', function (err) {
            })
        })

        var lastvalues = [];

        client.on('message', function (topic, message) {
            data = JSON.parse(message.toString());
            //     console.log(data)
            addLastValuesForMachine(data.hostname, data)
            // console.log(lastvalues)
        });

        function addLastValuesForMachine(hostname, data) {
            var found = false;
            var foundIndex = -1;
            for (var i = 0; i < lastvalues.length; i++) {
                if (lastvalues[i].hostname === hostname) {
                    found = true;
                    foundIndex = i;
                    break;
                }
            }

            if (found === true && foundIndex > -1) {//there is already a value for thes machine so replace it
                lastvalues[i] = data
            }
            else { // this is an unkon machine 
                console.log("New machine joined : " + hostname)
                lastvalues.push(data)
            }
            //html update
            document.getElementById("area").innerHTML = "";
            lastvalues.forEach(element => {
                document.getElementById("area").innerHTML += "<ul>" + element.hostname + " cpu: " + element.data.load.currentload.toFixed(2) + " uptime: " + element.data.uptime + "</ul>";
            });
        }

    </script>
</body>

</html>